---
import { getCollection } from 'astro:content';
import { aggregateContentData } from '@/middleware/content-processor.js'; 

import BlogLayout from '@/layouts/BlogLayout.astro'; 
import PostCard from '@/components/blog/PostCard.astro';
import Sidebar from '@/components/blog/Sidebar.astro'; 
import Pagination from '@/components/blog/Pagination.astro'; 

export async function getStaticPaths({ paginate }) { 
    const POSTS_PER_PAGE = 10; 

    const allPosts = await getCollection('blog');
    const { sortedTags } = aggregateContentData(allPosts);
    const uniqueTags = sortedTags.map(([tagSlug]) => tagSlug); 

    return uniqueTags.flatMap((tagSlug) => {
        const filteredPosts = allPosts
            .filter(post => 
                post.data.tags && 
                Array.isArray(post.data.tags) && 
                post.data.tags
                    .map(t => t.toString().trim().toLowerCase().replace(/\s+/g, '-'))
                    .includes(tagSlug)
            )
            .sort((a, b) => b.data.pubDate.getTime() - a.data.pubDate.getTime());

        if (filteredPosts.length === 0) return [];

        // 嵌套分页：/blog/tags/{tagSlug} (page=1) 和 /blog/tags/{tagSlug}/2 等
        return paginate(filteredPosts, {
            params: { tag: tagSlug },
            pageSize: POSTS_PER_PAGE
        });
    });
}

const { page } = Astro.props;
const posts = page.data;
const currentPage = page.currentPage;
const totalPages = page.lastPage;
const prevPageUrl = page.url.prev;
const nextPageUrl = page.url.next;

const tag = Astro.params.tag; // 当前 tag slug
const pageTitle = `标签: ${tag.split('-').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ')}`; // 格式化显示
const subTitle = `共 ${page.total} 篇文章`;
---

<BlogLayout title={pageTitle}>
	<div class="container mx-auto px-4 py-16 max-w-7xl">
		<div class="flex flex-col lg:flex-row gap-8">
			<main class="lg:w-3/4 w-full">
				<h1 class="text-4xl font-extrabold text-gray-900 mb-8 border-b pb-4 dark:text-white dark:border-gray-700">
					{pageTitle}
					<span class="text-xl font-medium text-gray-500 block mt-1 dark:text-gray-400">
						{subTitle}
					</span>
				</h1>

				<div class="grid grid-cols-1 md:grid-cols-2 gap-10">
					{posts.map((post) => (
						<PostCard post={post} />
					))}
				</div>

				<div class="mt-12">
					{totalPages > 1 && (
						<Pagination 
							currentPage={currentPage}
							totalPages={totalPages}
							prevPageUrl={prevPageUrl}
							nextPageUrl={nextPageUrl}
						/>
					)}
					{totalPages <= 1 && (
						<p class="text-center text-gray-500 italic mt-8 dark:text-gray-400">当前只有一页。</p>
					)}
				</div>
			</main>

			<aside class="lg:w-1/4 w-full lg:sticky lg:top-8 self-start">
				<Sidebar />
			</aside>
		</div>
	</div>
</BlogLayout>