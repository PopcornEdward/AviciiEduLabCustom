---
import { getCollection } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro'; 

// è¾…åŠ©å‡½æ•°ï¼šå°†æ—¥æœŸå¯¹è±¡æ ¼å¼åŒ–ä¸º YYYY/MM/DD è·¯å¾„æ®µã€‚
// ä¿ç•™æ­¤å‡½æ•°ä»…ç”¨äºæ ¼å¼åŒ–æ˜¾ç¤ºï¼Œä¸ç”¨äº getStaticPaths
function formatDatePath(date: Date): string {
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    return `${year}/${month}/${day}`;
}


// è·å–æ–‡ç« æ•°æ®çš„é™æ€è·¯å¾„ç”Ÿæˆå‡½æ•°
export async function getStaticPaths() {
    // 1. è·å–æ‰€æœ‰æ–‡ç« 
    const allPosts = await getCollection('blog', ({ data }) => {
        return data.draft !== true;
    });
    
    // --- å…³é”®ä¿®æ­£ï¼šç›´æ¥ä½¿ç”¨ post.slug ä½œä¸ºå®Œæ•´çš„è·¯å¾„ ---
    // å‡è®¾ post.slug å·²ç»åŒ…å«äº† 'YYYY/MM/DD/slug-name' çš„å®Œæ•´ç»“æ„
    // å› ä¸ºæ—¥å¿—æ˜¾ç¤º post.slug å·²ç»åŒ…å«æ—¥æœŸäº†ã€‚
    // --------------------------------------------------------

    // 2. ä¸ºæ¯ç¯‡æ–‡ç« æ„é€ è·¯å¾„
    return allPosts.map((post) => {
        
        // å…³é”®ä¿®æ­£ï¼ç›´æ¥ä½¿ç”¨ post.slugï¼Œä¸å†æ‰‹åŠ¨æ‹¼æ¥æ—¥æœŸè·¯å¾„ã€‚
        // post.slug çš„å€¼å¯èƒ½å·²ç»æ˜¯ "2025/11/21/ç‹å“¥å“¥_1763698166210"
        const fullSlug = post.slug; 

        // æ‰“å°æœ€ç»ˆç”Ÿæˆçš„è·¯å¾„ï¼Œç”¨äºä¸æµè§ˆå™¨è¯·æ±‚çš„è·¯å¾„åšå¯¹æ¯”
        console.log(`[FINAL PATH] Generated Path: /blog/${fullSlug}`);

        return {
            // params.slug å¿…é¡»åŒ…å«å®Œæ•´çš„è·¯å¾„éƒ¨åˆ†
            params: { slug: fullSlug }, 
            props: { post },
        };
    });
}


// ä» props ä¸­è·å–å½“å‰æ–‡ç« æ•°æ®
const { post } = Astro.props; 

// ğŸš¨ è°ƒè¯•ä¿¡æ¯ï¼šè·å– Astro è·¯ç”±å‚æ•°æ¥æ”¶åˆ°çš„å®é™…è·¯å¾„
const requestedSlug = Astro.params.slug; // æµè§ˆå™¨è¯·æ±‚çš„è·¯å¾„
const postSlug = post.slug; // å®é™…çš„æ–‡ç«  slug

// Markdown å†…å®¹æ¸²æŸ“
const { Content } = await post.render();

// æå–æ•°æ®ç”¨äºå¸ƒå±€
const { title, author, pubDate, categories, tags } = post.data;

const formattedDate = pubDate ? new Date(pubDate).toLocaleDateString('zh-CN', {
    year: 'numeric',
    month: 'long',
    day: 'numeric',
}) : 'æœªçŸ¥æ—¥æœŸ';

// åŠ¨æ€å¤„ç†åˆ†ç±»ï¼šä¼˜å…ˆä½¿ç”¨ categories å­—æ®µï¼Œå¦‚æœæ˜¯æ•°ç»„å–ç¬¬ä¸€ä¸ªæˆ– joinï¼Œå¦‚æœä¸å­˜åœ¨åˆ™ "æœªåˆ†ç±»"
let categoryDisplay = categories || "æœªåˆ†ç±»";
if (Array.isArray(categoryDisplay)) {
    categoryDisplay = categoryDisplay.length > 0 ? categoryDisplay.join(', ') : "æœªåˆ†ç±»";
} else if (typeof categoryDisplay !== 'string') {
    categoryDisplay = "æœªåˆ†ç±»";
}

// é¡µé¢ç»“æ„
---

<BaseLayout title={title}>
    <div class="container mx-auto px-4 py-16 max-w-4xl">
        <article class="bg-white p-8 rounded-xl shadow-2xl">
            <!-- ğŸš¨ æœ€ç»ˆè°ƒè¯•ä¿¡æ¯ ğŸš¨ -->
            <div class="bg-blue-100 border border-blue-400 text-blue-700 px-4 py-3 rounded mb-6 text-sm">
                <p class="font-bold">âœ… æœ€ç»ˆè·¯å¾„æ£€æŸ¥</p>
                <p class="mt-1 break-all">æµè§ˆå™¨è¯·æ±‚ (`Astro.params.slug`): `{requestedSlug}`</p>
                <p class="mt-1 break-all">Astro ç”Ÿæˆ (`post.slug`): `{postSlug}`</p>
                <p class="mt-1 break-all font-bold">è¯·ç¡®è®¤ä¸¤è€…å®Œå…¨ç›¸åŒï¼š`2025/11/21/ç‹å“¥å“¥_1763698166210`</p>
            </div>
            <!-- ---------------------- -->

            <!-- Header -->
            <header class="mb-10 border-b pb-6">
                <h1 class="text-4xl lg:text-5xl font-extrabold text-gray-900 mb-4 leading-tight">
                    {title}
                </h1>
                <div class="text-lg text-gray-500 flex items-center space-x-4">
                    <span class="flex items-center">ä½œè€…: <span class="font-semibold ml-1 text-blue-600">{author}</span></span>
                    <span>|</span>
                    {/* ç¡®ä¿ pubDate æ˜¯æœ‰æ•ˆçš„ Date å¯¹è±¡ */}
                    {pubDate && (
                        <span class="flex items-center">å‘å¸ƒäº: <time datetime={new Date(pubDate).toISOString()}>{formattedDate}</time></span>
                    )}
                </div>
                <div class="mt-2 text-sm text-gray-500">
                    <span class="bg-blue-100 text-blue-800 px-2 py-0.5 rounded-full mr-2">åˆ†ç±»: {categoryDisplay}</span>
                    {tags && tags.map((tag) => (
                        <span class="bg-gray-200 text-gray-700 px-2 py-0.5 rounded-full mr-2">#{tag}</span>
                    ))}
                </div>
            </header>

            <!-- Content -->
            <div class="prose prose-xl max-w-none text-gray-700">
                <Content />
            </div>

            <!-- Footer (å¯é€‰: è¯„è®ºåŒºæˆ–è¿”å›é“¾æ¥) -->
            <footer class="mt-12 pt-6 border-t">
                <a href="/blog" class="inline-flex items-center text-blue-600 hover:text-blue-800 font-semibold transition">
                    <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                    è¿”å›åšå®¢åˆ—è¡¨
                </a>
            </footer>
        </article>
    </div>
</BaseLayout>