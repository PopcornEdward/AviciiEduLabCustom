---
import { getCollection } from 'astro:content';
// 使用您的布局导入名称和路径
import BlogLayout from '../../layouts/BlogLayout.astro'; 
import PostCard from '../../components/blog/PostCard.astro';
import Sidebar from '../../components/blog/Sidebar.astro';
// 已移除：import { paginate } from 'astro'; // 静态路由不能导入此函数

// 每页显示的文章数量
const POSTS_PER_PAGE = 10;

// 1. 获取所有文章并按日期排序 (最新文章在前)
const allPosts = await getCollection('blog', ({ data }) => {
    // 排除草稿
    return data.draft !== true;
});
const sortedPosts = allPosts.sort(
    (a, b) => new Date(b.data.pubDate).valueOf() - new Date(a.data.pubDate).valueOf()
);

// --- 修复点：手动切片和构造分页对象 ---

// 计算总页数
const totalPages = Math.ceil(sortedPosts.length / POSTS_PER_PAGE);

// 手动切片获取第一页文章数据
const pageData = sortedPosts.slice(0, POSTS_PER_PAGE);

// 构造一个模拟的分页对象，以兼容页面底部的渲染逻辑
const firstPage = {
    data: pageData, // 第一页的文章列表
    currentPage: 1, // 当前是第1页
    total: sortedPosts.length, // 总文章数
    lastPage: totalPages, // 最后一页编号
    url: {
        prev: undefined, // 首页没有上一页
        next: totalPages > 1 ? `/blog/2` : undefined // 如果总页数 > 1，则有下一页
    }
}; 

// --- 侧边栏数据提取逻辑（保持不变） ---

// 动态生成分类数据
const categoriesMap = sortedPosts.reduce((acc, post) => {
    const categoryName = post.data.category || '未分类';
    acc[categoryName] = (acc[categoryName] || 0) + 1;
    return acc;
}, {} as Record<string, number>);
const sidebarCategories = Object.entries(categoriesMap).map(([name, count]) => ({ name, count }));

// 标签数据
const tagsSet = new Set<string>();
sortedPosts.forEach(post => {
    if (Array.isArray(post.data.tags)) {
        post.data.tags.forEach(tag => tagsSet.add(tag));
    }
});
const tags = Array.from(tagsSet).length > 0 ? Array.from(tagsSet).slice(0, 8) : ["NextJs", "Tailwind", "Technology", "Software", "Silicon", "Astro", "Web"];

// 辅助函数：生成分页链接
function getPageURL(pageNumber: number) {
    if (pageNumber <= 1) return '/blog'; // 首页链接
    return `/blog/${pageNumber}`;
}
---

<BlogLayout title={`博客列表 - 首页`}>
    <!-- 容器和标题 -->
    <div class="container mx-auto px-4 py-16 max-w-7xl">
        <h1 class="text-4xl font-extrabold text-gray-900 mb-12 border-b pb-4">
            最新文章 ({firstPage.total} 篇文章，当前第 {firstPage.currentPage} 页)
        </h1>
        
        <main class="grid grid-cols-1 lg:grid-cols-3 gap-12">
            
            <!-- Articles List Area (占 2/3 宽度) -->
            <section class="lg:col-span-2">
                <!-- 文章列表网格：确保卡片每行显示 2 个 -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    {firstPage.data.map((post) => (
                        <PostCard post={post} />
                    ))}
                </div>

                <!-- 分页导航：使用 firstPage 的数据 -->
                <div class="flex justify-center mt-12">
                    <div class="flex items-center space-x-2">
                        {/* 上一页按钮 - 首页禁用 */}
                        <a 
                            href="#" 
                            class="w-10 h-10 flex items-center justify-center text-gray-500 border border-gray-300 rounded-lg transition pointer-events-none opacity-50"
                            aria-label="Previous Page"
                        >
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                        </a>
                        
                        {/* 页面数字列表 */}
                        {[...Array(firstPage.lastPage)].map((_, index) => {
                            const pageNum = index + 1;
                            const isActive = pageNum === firstPage.currentPage;
                            const url = getPageURL(pageNum);

                            return (
                                <a 
                                    href={url} 
                                    class:list={[
                                        "w-10 h-10 flex items-center justify-center rounded-lg transition font-semibold",
                                        {'bg-blue-600 text-white': isActive},
                                        {'text-gray-700 border border-gray-300 hover:bg-gray-100': !isActive}
                                    ]}
                                >
                                    {pageNum}
                                </a>
                            );
                        })}

                        {/* 下一页按钮 */}
                         <a 
                            href={firstPage.url.next ? getPageURL(firstPage.currentPage + 1) : '#'} 
                            class:list={[
                                "w-10 h-10 flex items-center justify-center text-gray-500 border border-gray-300 rounded-lg transition",
                                {'pointer-events-none opacity-50': !firstPage.url.next}, // 禁用样式
                                {'hover:bg-gray-100': !!firstPage.url.next}
                            ]}
                            aria-label="Next Page"
                        >
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                        </a>
                        
                    </div>
                </div>
            </section>

            <!-- Sidebar Area (占 1/3 宽度) -->
            <aside class="lg:col-span-1">
                <Sidebar categories={sidebarCategories} tags={tags} />
            </aside>
        </main>
    </div>
</BlogLayout>